---
title: "GPU Passthrough et Looking Glass: transformer un PC Linux en station de jeu hybride"
summary: "Setup Guide pour Ubuntu"
date: 2025-06-16T00:00:00+01:00
draft: false
tags: ['passthrough', 'gpu', 'game', 'vm', 'qemu']
pin: false
---

*This article was generated by AI based on the [homelab-gaming](https://github.com/dmachard/homelab-gaming) project.*

Mon besoin
1. **Mode TV/Salon** : la VM Windows affiche directement sur la TV via HDMI, manettes Xbox pour du gaming familial
2. **Mode Bureau** : accès à la même VM via Looking Glass depuis le PC, clavier/souris pour des jeux solo ou du travail

Le GPU passthrough combiné à Looking Glass permet de répondre à ce besoin: faire tourner une VM Windows avec accès direct au GPU, accessible soit sur une TV pour du gaming familial, soit depuis le bureau via [Looking Glass](https://looking-glass.io/), tout en conservant le PC Linux pleinement fonctionnel.


## Les technos clés

### GPU Passthrough

Le GPU passthrough, aussi appelé VFIO, est une technique de virtualisation permettant de donner à une machine virtuelle un accès direct et exclusif à une carte graphique physique. Contrairement à l'émulation graphique classique qui passe par l'hyperviseur et dégrade fortement les performances, le passthrough offre des performances quasi-natives.

**Principe de fonctionnement** : le GPU est isolé du système hôte au démarrage via les groupes IOMMU du processeur. La carte graphique est alors "détachée" du noyau Linux et assignée directement à la VM. Du point de vue de Windows, c'est comme si la carte était physiquement connectée à une machine dédiée.

**Prérequis matériels** :
- Processeur avec support IOMMU (Intel VT-d ou AMD-Vi)
- Carte mère compatible
- De préférence deux GPU (un pour l'hôte, un pour la VM) ou un iGPU + GPU dédié

Dans ce guide, le GPU AMD RX 7800 XT est entièrement dédié à la VM Windows, tandis que l'hôte Ubuntu utilise le GPU intégré du Ryzen 9 9900X.

### Looking Glass

**Looking Glass** est un logiciel open source qui résout un problème majeur du GPU passthrough : comment accéder à l'affichage de la VM sans avoir un second moniteur dédié ?

**Le problème** : avec le passthrough classique, le GPU est physiquement connecté à un écran. Pour utiliser la VM, il faut soit switcher d'écran, soit avoir deux moniteurs séparés.

**La solution Looking Glass** : ce système capture l'affichage du GPU dans la VM et le transmet au système hôte via une zone de mémoire partagée (shared memory). Un client léger sur Linux affiche alors le rendu dans une fenêtre, avec une latence extrêmement faible (typiquement < 1ms).

**Architecture** :
- Un binaire "host" tourne dans la VM Windows et capture les frames du GPU
- Un binaire "client" tourne sur l'hôte Linux et affiche le flux
- Communication via `/dev/kvmfr0` (mémoire partagée)
- Support des périphériques USB partagés (clavier/souris)

L'avantage majeur : basculer instantanément entre Linux et la VM Windows sans changer d'écran ni de cable, tout en conservant des performances de jeu optimales.

## Architecture de la solution

### Matériel

La configuration repose sur du matériel compatible avec la virtualisation et le passthrough GPU :

- **Processeur** : AMD Ryzen 9 9900X (support IOMMU)
- **Carte graphique** : AMD Radeon RX 7800 XT (passée à la VM)
- **Affichage** : double sortie HDMI vers TV et moniteur de bureau
- **Périphériques** : manettes Xbox sans fil

### Stack logicielle

- **Système hôte** : Ubuntu 25.10
- **Hyperviseur** : QEMU avec libvirt
- **Système invité** : Windows 10
- **Accès distant** : Looking Glass pour un affichage à faible latence


## Mise en place côté hôte Linux

### Isolation du matériel

La première étape consiste à isoler la carte graphique du système hôte pour la réserver exclusivement à la VM.
```bash
cd gpu_passthrough/
sudo ./config.sh
```

Pour permettre à libvirt d'accéder au device Looking Glass, éditer la configuration des groupes de contrôle en ajoutant `/dev/kvmfr0` dans la liste des périphériques autorisés :
```bash
sudo vim /etc/libvirt/qemu.conf
```

Chercher la section `cgroup_device_acl` et ajouter l'entrée manquante :
```
cgroup_device_acl = [
    "/dev/null", "/dev/full", "/dev/zero",
    "/dev/random", "/dev/urandom",
    "/dev/ptmx", "/dev/kvm",
    "/dev/userfaultfd",
    "/dev/kvmfr0"
]
```

Redémarrer le service :
```bash
sudo systemctl restart libvirtd
```

Après un redémarrage complet de la machine, vérifier que l'isolation fonctionne :
```bash
cd gpu_passthrough/
sudo ./check.sh
```

### Import de la VM
```bash
cd vm_qemu
./import_vm.sh
```

### Installation du client Looking Glass

Looking Glass permet d'accéder à l'affichage de la VM avec une latence minimale.
```bash
cd looking_glass
./install.sh
```

Deux icônes sont disponibles dans le lanceur d'applications selon l'état de la connexion (vert pour connecté, rouge pour déconnecté).

## Configuration de la VM Windows

### Monitoring du GPU

Déployer un serveur API léger en Python dans la VM pour surveiller l'état du GPU depuis l'hôte. Les scripts `status_gpu.py` et `status_gpu.bat` situés dans `scripts_vm/` exposent ces informations sur le port 8081.

### Installation de Looking Glass Host

Côté Windows, télécharger et installer le binaire host de Looking Glass depuis https://looking-glass.io/artifact/stable/host. Ce composant capture l'affichage et le transmet au client Linux via la mémoire partagée.

### Amélioration de l'expérience

**AutoHotkey** permet de créer des raccourcis personnalisés accessibles depuis les manettes Xbox. Les scripts `xinput.ahk` et `gamepad.ahk` du dossier `autohotkey/` doivent être configurés au démarrage de Windows pour quitter un émulateur sans toucher au clavier.

**SoundSwitch** simplifie la bascule entre les sorties audio, notamment entre les enceintes du PC et le système audio de la TV via HDMI. Installation depuis https://soundswitch.aaflao.me/

**OpenRGB** désactive les LEDs de la carte graphique. Installation depuis https://openrgb.org/

### Émulation console

Ryujinx offre d'excellentes performances pour l'émulation Nintendo Switch dans cet environnement grâce à l'accès direct au GPU. Installation depuis https://ryujinx.app/

### Sécurisation réseau

Activer le pare-feu Windows et bloquer tout le trafic par défaut. Créer une exception uniquement pour le port TCP 8081 en entrée, nécessaire à l'API de monitoring.

## Résultat

Cette architecture offre une flexibilité remarquable : gaming sur TV avec manettes pour des sessions familiales, ou utilisation depuis le bureau via Looking Glass pour des jeux nécessitant clavier et souris, sans jamais perdre l'accès à l'environnement Linux natif.

Les performances sont au rendez-vous grâce au passthrough GPU qui élimine la couche d'émulation graphique. Looking Glass délivre une latence imperceptible pour un usage bureautique ou gaming.

## Ressources

- [Dépôt GitHub du projet](https://github.com/votre-username/homelab-gaming)
- [Documentation Looking Glass](https://looking-glass.io/)
- [Guide VFIO Arch Linux](https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF)