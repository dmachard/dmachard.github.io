<!doctype html><html lang=en-US><head><meta charset=utf-8><meta name=viewport content="width=device-width"><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9 crossorigin=anonymous><link rel=stylesheet href=https://dmachard.github.io/css/gists.css><title>GPU Passthrough + Looking Glass Guide - My technical gists</title><link rel=icon type=image/x-icon href=/images/avatar.png><meta name=theme-color content="#1e2327"><meta name=description content="Setup Guide for Ubuntu"><meta name=keywords content="blog,technical"><meta name=robots content="noodp"><link rel=canonical href=https://dmachard.github.io/posts/0064-gpu-passthrough-lookingglass/><meta name=twitter:card content="summary"><meta name=twitter:title content="GPU Passthrough + Looking Glass Guide - My technical gists"><meta name=twitter:description content="Setup Guide for Ubuntu"><meta name=twitter:site content="https://dmachard.github.io/"><meta name=twitter:creator content><meta name=twitter:image content="https://dmachard.github.io/"><meta property="og:type" content="article"><meta property="og:title" content="GPU Passthrough + Looking Glass Guide - My technical gists"><meta property="og:description" content="Setup Guide for Ubuntu"><meta property="og:url" content="https://dmachard.github.io/posts/0064-gpu-passthrough-lookingglass/"><meta property="og:site_name" content="GPU Passthrough + Looking Glass Guide"><meta property="og:image" content="https://dmachard.github.io/"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2025-06-16 00:00:00 +0100 +0100"></head><body><main><div class=container-xl><div class="d-flex flex-sm-row flex-column"><div class="p-2 pt-0 col-sm-3"><div class="d-flex flex-column sticky-top"><div class="d-flex flex-sm-column"><div class="pt-3 pt-md-2 pb-2 order-sm-1 order-2"><p class="fs-4 fw-bold p-0 m-0">Denis Machard</p><p class="fs-5 text-dark-emphasis">My technical gists</p></div><div class="pt-2 pe-2 col-3 col-sm-12 order-sm-2 order-1"><a href=/images/profile.png><img width=250 class="img-thumbnail rounded-pill border bg-white" src=/images/profile.png></a></div></div><div class="mt-3 fs-6 text-dark-emphasis">Infrastructure background, developer mindset. I build things for pleasure.</div><div class=pt-3><ul class=list-unstyled></ul></div><div class="pt-3 pb-4"><a style="margin:0 10px 10px 0" href=https://github.com/dmachard><img alt=@github width=32 height=32 src=https://dmachard.github.io/images/github.png></a>
<a style="margin:0 10px 10px 0" href=https://fosstodon.org/@dmachard><img alt=@mastodon width=32 height=32 src=https://dmachard.github.io/images/mastodon.png></a>
<a style="margin:0 10px 10px 0" href=https://dmachard.github.io/index.xml><img alt=@rss width=32 height=32 src=https://dmachard.github.io/images/rss.png></a></div></div></div><div class="p-2 pt-0 col-sm-9"><ul class="nav nav-underline sticky-top d-flex pt-2 mb-md-4 bg-white border-bottom"><li class="nav-item px-md-1"><a class="nav-link text-dark-emphasis" href=https://dmachard.github.io/><svg height="16" viewBox="0 0 16 16" width="16"><path class="me-1" fill-rule="evenodd" d="m11.294.984 3.722 3.722a1.75 1.75.0 01-.504 2.826l-1.327.613a3.089 3.089.0 00-1.707 2.084l-.584 2.454c-.317 1.332-1.972 1.8-2.94.832L5.75 11.311 1.78 15.28A.749.749.0 11.72 14.22l3.969-3.97-2.204-2.204c-.968-.968-.5-2.623.832-2.94l2.454-.584a3.08 3.08.0 002.084-1.707l.613-1.327a1.75 1.75.0 012.826-.504zM6.283 9.723l2.732 2.731a.25.25.0 00.42-.119l.584-2.454a4.586 4.586.0 012.537-3.098l1.328-.613a.25.25.0 00.072-.404l-3.722-3.722a.25.25.0 00-.404.072l-.613 1.328A4.584 4.584.0 016.119 5.981l-2.454.584a.25.25.0 00-.119.42l2.731 2.732z"/></svg><span class=m-1>Pinned</span>
<span class="badge fw-normal bg-secondary bg-opacity-25 text-opacity-50 rounded-pill text-dark-emphasis">5</span></a></li><li class="nav-item px-md-1"><a class='nav-link text-dark active' href=https://dmachard.github.io//posts/><svg height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M0 1.75A.75.75.0 01.75 1h4.253c1.227.0 2.317.59 3 1.501A3.744 3.744.0 0111.006 1h4.245a.75.75.0 01.75.75v10.5a.75.75.0 01-.75.75h-4.507a2.25 2.25.0 00-1.591.659l-.622.621a.75.75.0 01-1.06.0l-.622-.621A2.25 2.25.0 005.258 13H.75A.75.75.0 010 12.25V1.75zm8.755 3a2.25 2.25.0 012.25-2.25H14.5v9h-3.757c-.71.0-1.4.201-1.992.572l.004-7.322zm-1.504 7.324.004-5.073-.002-2.253A2.25 2.25.0 005.003 2.5H1.5v9h3.757a3.75 3.75.0 011.994.574z"/></svg><span class=m-1>Gists</span>
<span class="badge fw-normal bg-secondary bg-opacity-25 text-opacity-50 rounded-pill text-dark-emphasis">59</span></a></li><li class="nav-item px-md-1"><a class='nav-link text-dark-emphasis' href=https://dmachard.github.io//tags/><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M2.5 7.775V2.75a.25.25.0 01.25-.25h5.025a.25.25.0 01.177.073l6.25 6.25a.25.25.0 010 .354l-5.025 5.025a.25.25.0 01-.354.0l-6.25-6.25A.25.25.0 012.5 7.775zm-1.5.0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464.0.91.184 1.238.513l6.25 6.25a1.75 1.75.0 010 2.474l-5.026 5.026a1.75 1.75.0 01-2.474.0l-6.25-6.25A1.75 1.75.0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z"/></svg><span class=m-1>Tags</span>
<span class="badge fw-normal bg-secondary bg-opacity-25 text-opacity-50 rounded-pill text-dark-emphasis">49</span></a></li></ul><div class="d-flex flex-column border rounded mt-4 mt-md-0"><div class="border-bottom bg-light markdown-sticky-top"><div class="d-flex flex-row align-items-center"><div class=btn-group role=group><button type=button class=btn data-bs-toggle=dropdown aria-expanded=false><svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16"><path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zM3 8A1 1 0 111 8a1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"/></svg></button><ul class=dropdown-menu id=toc-list><li><h6 class=dropdown-header>Table of Content</h6></li></ul></div><div class="flex-fill text-secondary fs-7"><relative-time datetime="Mon, 16 Jun 2025 00:00:00 +0100"></relative-time></div><div class="pe-2 d-none d-md-block"><a class="badge text-bg-secondary text-dark fw-normal bg-opacity-25 pb-1 link-underline link-underline-opacity-0 link-underline-opacity-100-hover" href=/tags/passthrough>passthrough</a>
<a class="badge text-bg-secondary text-dark fw-normal bg-opacity-25 pb-1 link-underline link-underline-opacity-0 link-underline-opacity-100-hover" href=/tags/gpu>gpu</a>
<a class="badge text-bg-secondary text-dark fw-normal bg-opacity-25 pb-1 link-underline link-underline-opacity-0 link-underline-opacity-100-hover" href=/tags/game>game</a>
<a class="badge text-bg-secondary text-dark fw-normal bg-opacity-25 pb-1 link-underline link-underline-opacity-0 link-underline-opacity-100-hover" href=/tags/vm>vm</a>
<a class="badge text-bg-secondary text-dark fw-normal bg-opacity-25 pb-1 link-underline link-underline-opacity-0 link-underline-opacity-100-hover" href=/tags/qemu>qemu</a></div></div></div><div class="pt-4 px-2 pb-3"><article class="markdown-body container-lg"><h1 id=-gpu-passthrough--looking-glass-guide>ðŸŽ® GPU Passthrough + Looking Glass Guide</h1><p>This guide explains how to set up a Windows VM with GPU passthrough and Looking Glass on Ubuntu 25.04.</p><h2 id=prerequisites><a class=anchor href=#prerequisites>Prerequisites</a></h2><ul><li><p>CPU with <strong>VT-d/AMD-Vi</strong> enabled in BIOS:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lscpu | grep <span style=color:#e6db74>&#34;Virtualization&#34;</span>
</span></span><span style=display:flex><span>Virtualization: VT-x   <span style=color:#75715e># Intel</span>
</span></span><span style=display:flex><span>Virtualization: AMD-V  <span style=color:#75715e># AMD</span>
</span></span></code></pre></div></li><li><p>Two GPUs (one for Linux, one for the VM):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lspci -nn | grep VGA
</span></span><span style=display:flex><span>00:02.0 VGA compatible controller <span style=color:#f92672>[</span>0300<span style=color:#f92672>]</span>: Intel Corporation Meteor Lake-P <span style=color:#f92672>[</span>Intel Arc Graphics<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>8086:7d55<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>rev 08<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>01:00.0 VGA compatible controller <span style=color:#f92672>[</span>0300<span style=color:#f92672>]</span>: NVIDIA Corporation AD106M <span style=color:#f92672>[</span>GeForce RTX <span style=color:#ae81ff>4070</span> Max-Q / Mobile<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>10de:2820<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>rev a1<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>Note the IDs in square brackets for the GPU you want to passthrough â€” in this case: <code>10de:2820</code>.</p></li><li><p>Two audio controllers:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lspci -nn | grep -i audio
</span></span><span style=display:flex><span>00:1f.3 Multimedia audio controller <span style=color:#f92672>[</span>0401<span style=color:#f92672>]</span>: Intel Corporation Meteor Lake-P HD Audio Controller <span style=color:#f92672>[</span>8086:7e28<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>rev 20<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>01:00.1 Audio device <span style=color:#f92672>[</span>0403<span style=color:#f92672>]</span>: NVIDIA Corporation AD106M High Definition Audio Controller <span style=color:#f92672>[</span>10de:22bd<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>rev a1<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>Again, note the IDs â€” in this case: <code>10de:22bd</code>.</p></li><li><p><strong>HDMI Dummy Plug (optional)</strong>: helpful for Looking Glass to trick the guest GPU into enabling display output.</p></li></ul><h2 id=isolating-your-gpu><a class=anchor href=#isolating-your-gpu>Isolating your GPU</a></h2><h3 id=install-qemukvm><a class=anchor href=#install-qemukvm>Install QEMU/KVM</a></h3><p>QEMU is an open-source hypervisor that works with KVM to take advantage of hardware acceleration.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt install qemu-kvm virt-manager bridge-utils linux-headers-<span style=color:#66d9ef>$(</span>uname -r<span style=color:#66d9ef>)</span> dkms
</span></span><span style=display:flex><span>sudo reboot now
</span></span></code></pre></div><p>Enable libvirtd and add your user to the <code>libvirt</code> group:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl enable libvirtd.service
</span></span><span style=display:flex><span>sudo systemctl start libvirtd.service
</span></span><span style=display:flex><span>sudo usermod -aG libvirt $USER
</span></span></code></pre></div><h3 id=enable-iommu-in-grub><a class=anchor href=#enable-iommu-in-grub>Enable IOMMU in GRUB</a></h3><p>IOMMU (Input-Output Memory Management Unit) is required to isolate and assign hardware devices to VMs securely.</p><p>Edit the GRUB configuration to enable IOMMU and specify the device IDs:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo vim /etc/default/grub
</span></span></code></pre></div><p>For <strong>Intel</strong> CPUs:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>GRUB_CMDLINE_LINUX_DEFAULT=&#34;quiet splash intel_iommu=on iommu=pt vfio-pci.ids=10de:2820,10de:22bd&#34;
</span></span></code></pre></div><p>For <strong>AMD</strong> CPUs, replace <code>intel_iommu=on</code> with <code>amd_iommu=on</code>.</p><p>Update GRUB:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo grub-mkconfig -o /boot/grub/grub.cfg
</span></span><span style=display:flex><span>sudo reboot now
</span></span></code></pre></div><h3 id=bind-the-gpu-to-vfio><a class=anchor href=#bind-the-gpu-to-vfio>Bind the GPU to VFIO</a></h3><p>VFIO allows direct and secure assignment of devices to VMs.</p><p>Create the config:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo vim /etc/modprobe.d/vfio.conf
</span></span></code></pre></div><p>Add:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>options vfio-pci ids=10de:2820,10de:22bd
</span></span></code></pre></div><p>Blacklist other drivers to prevent them from binding to the GPU:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo tee /etc/modprobe.d/blacklist-nvidia.conf &gt; /dev/null <span style=color:#e6db74>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>blacklist nouveau
</span></span></span><span style=display:flex><span><span style=color:#e6db74>blacklist nvidia
</span></span></span><span style=display:flex><span><span style=color:#e6db74>blacklist nvidiafb
</span></span></span><span style=display:flex><span><span style=color:#e6db74>blacklist rivafb
</span></span></span><span style=display:flex><span><span style=color:#e6db74>blacklist nvidia_drm
</span></span></span><span style=display:flex><span><span style=color:#e6db74>blacklist nvidia_uvm
</span></span></span><span style=display:flex><span><span style=color:#e6db74>blacklist nvidia_modeset
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>Update the initramfs:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo update-initramfs -c -k <span style=color:#66d9ef>$(</span>uname -r<span style=color:#66d9ef>)</span>
</span></span></code></pre></div><h3 id=enable-dma-gpu-transfers-looking-glass><a class=anchor href=#enable-dma-gpu-transfers-looking-glass>Enable DMA GPU transfers (Looking Glass)</a></h3><p>IVSHMEM (Inter-VM Shared Memory) is a QEMU feature allowing memory segments to be shared between the host and guest. Looking Glass uses it to facilitate high-speed, low-latency frame sharing via DMA (Direct Memory Access).</p><p>Download the Looking Glass source: <a href=https://looking-glass.io/artifact/B7/source>https://looking-glass.io/artifact/B7/source</a></p><p>Extract the archive and navigate to the <code>module/</code> directory:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd looking-glass-B7/module
</span></span></code></pre></div><p>Install the kernel module:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dkms install .
</span></span></code></pre></div><p>Create <code>/etc/modprobe.d/kvmfr.conf</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>options kvmfr static_size_mb<span style=color:#f92672>=</span><span style=color:#ae81ff>128</span>
</span></span></code></pre></div><p>Create <code>/etc/modules-load.d/kvmfr.conf</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kvmfr
</span></span></code></pre></div><p>Create a udev rule to allow your user access to <code>/dev/kvmfr0</code> (replace <code>user</code> with your username):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo tee /etc/udev/rules.d/99-kvmfr.rules &gt; /dev/null <span style=color:#e6db74>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>SUBSYSTEM==&#34;kvmfr&#34;, OWNER=&#34;user&#34;, GROUP=&#34;kvm&#34;, MODE=&#34;0660&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><h3 id=verify-gpu-isolation><a class=anchor href=#verify-gpu-isolation>Verify GPU Isolation</a></h3><p>Reboot and verify</p><p>Run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lspci -k | grep -E <span style=color:#e6db74>&#34;Audio|VGA|vfio-pci&#34;</span>
</span></span></code></pre></div><p>Expected output:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>01:00.0 VGA compatible controller: NVIDIA Corporation AD106M [...]
</span></span><span style=display:flex><span>    Kernel driver in use: vfio-pci
</span></span><span style=display:flex><span>01:00.1 Audio device: NVIDIA Corporation AD106M High Definition Audio [...]
</span></span><span style=display:flex><span>    Kernel driver in use: vfio-pci
</span></span></code></pre></div><p><code>vfio-pci</code> should be listed as the kernel driver in use.</p><p>You should now also have the character device /dev/kvmfr0</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ls -l /dev/kvmfr0
</span></span></code></pre></div><p>Expected:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>crw------- 1 user kvm 242, 0 Jun 16 12:00 /dev/kvmfr0
</span></span></code></pre></div><h2 id=create-your-dedicated-gaming-vm><a class=anchor href=#create-your-dedicated-gaming-vm>Create your dedicated gaming VM</a></h2><h3 id=download-the-windows-iso><a class=anchor href=#download-the-windows-iso>Download the Windows ISO</a></h3><p>Get a copy of Windows from:</p><ul><li><a href=https://www.microsoft.com/en-us/software-download/windows10>Windows 10</a></li><li><a href=https://www.microsoft.com/en-us/software-download/windows11>Windows 11</a></li></ul><p>Download the <code>virtio-win</code> ISO from the <a href=https://github.com/virtio-win/virtio-win-pkg-scripts/blob/master/README.md>official repository</a></p><p>and move all ISO to <code>/var/lib/libvirt/images/</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo chown libvirt-qemu:kvm /var/lib/libvirt/images/*.iso
</span></span></code></pre></div><h3 id=launch-the-vm-with-virt-install><a class=anchor href=#launch-the-vm-with-virt-install>Launch the VM with virt-install</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo virt-install --name<span style=color:#f92672>=</span>Win10-gaming --vcpus<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span> --memory<span style=color:#f92672>=</span><span style=color:#ae81ff>16384</span> --os-variant<span style=color:#f92672>=</span>win10 --features kvm_hidden<span style=color:#f92672>=</span>on --machine q35 --cdrom<span style=color:#f92672>=</span>/var/lib/libvirt/images/Win10_22H2_French_x64v1.iso --disk path<span style=color:#f92672>=</span>/var/lib/libvirt/images/win10.qcow2,size<span style=color:#f92672>=</span>100,bus<span style=color:#f92672>=</span>virtio,format<span style=color:#f92672>=</span>qcow2 --disk path<span style=color:#f92672>=</span>/var/lib/libvirt/images/virtio-win-0.1.271.iso,device<span style=color:#f92672>=</span>cdrom,bus<span style=color:#f92672>=</span>sata --graphics spice,listen<span style=color:#f92672>=</span>127.0.0.1 --video virtio --network network<span style=color:#f92672>=</span>default,model<span style=color:#f92672>=</span>virtio --hostdev pci_0000_01_00_0 --hostdev pci_0000_01_00_1 --wait -1
</span></span></code></pre></div><p>Command details</p><table><thead><tr><th>Option</th><th>Purpose</th><th>Example Value</th></tr></thead><tbody><tr><td><code>--name</code></td><td>Name of the VM</td><td><code>Win10-gaming</code></td></tr><tr><td><code>--vcpus</code></td><td>Number of virtual CPUs exposed to the guest</td><td><code>8</code></td></tr><tr><td><code>--memory</code></td><td>Guest RAM in <strong>MiB</strong> (16â€¯384â€¯MiB â‰ˆÂ 16â€¯GB)</td><td><code>16384</code></td></tr><tr><td><code>--os-variant</code></td><td>Optimised defaults for the guest OS</td><td><code>win10</code></td></tr><tr><td><code>--features kvm_hidden=on</code></td><td>Hides KVM from the guest to avoid DRM/antiâ€‘cheat issues</td><td><code>kvm_hidden=on</code></td></tr><tr><td><code>--machine</code></td><td>Chipset / machine type</td><td><code>q35</code></td></tr><tr><td><code>--cdrom</code></td><td>Windows installation ISO</td><td><code>Win10_22H2_French_x64v1.iso</code></td></tr><tr><td><code>--disk</code> (1)</td><td><strong>System disk</strong>: path, size (GiB), virtio bus</td><td><code>win10.qcow2,size=100</code></td></tr><tr><td><code>--disk</code> (2)</td><td><strong>VirtIO driver ISO</strong> attached as CDâ€‘ROM</td><td><code>virtio-win-0.1.271.iso,device=cdrom</code></td></tr><tr><td><code>--graphics</code></td><td>Uses SPICE on localhost for display</td><td><code>spice,listen=127.0.0.1</code></td></tr><tr><td><code>--video</code></td><td>Video adapter model inside the VM</td><td><code>virtio</code></td></tr><tr><td><code>--network</code></td><td>Connects to default virtual network, virtio model</td><td><code>network=default,model=virtio</code></td></tr><tr><td><code>--hostdev pci_0000_01_00_0</code></td><td><strong>GPU passthrough</strong> â€“ PCIe address <em>0000:01:00.0</em> (NVIDIA RTXÂ 4070)</td><td></td></tr><tr><td><code>--hostdev pci_0000_01_00_1</code></td><td><strong>Audio controller passthrough</strong> â€“ PCIe address <em>0000:01:00.1</em> (HD Audio)</td><td></td></tr><tr><td><code>--wait -1</code></td><td>Waits until installation completes before returning</td><td><code>-1</code></td></tr></tbody></table><h3 id=install-windows><a class=anchor href=#install-windows>Install Windows</a></h3><p>Use SPICE to connect and install Windows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>virt-viewer Win10-gaming
</span></span></code></pre></div><p>During installation:</p><ul><li>Browse to the VirtIO drive to load storage drivers when prompted.</li></ul><h3 id=install-drivers><a class=anchor href=#install-drivers>Install Drivers</a></h3><p>Once inside Windows:</p><ul><li>Run <code>virtio-win-guest-tools.exe</code> from the VirtIO ISO.</li><li>Install GPU drivers: <a href=https://www.nvidia.com/en-us/geforce/drivers/>Nvidia</a>, <a href=https://www.amd.com/en/support/download/drivers.html>AMD</a>, or <a href=https://www.intel.com/content/www/us/en/download-center/home.html>Intel</a>.</li></ul><h3 id=install-lookingglass><a class=anchor href=#install-lookingglass>Install LookingGlass</a></h3><p>Looking Glass is an open source application that allows the use of a KVM (Kernel-based Virtual Machine) configured for VGA PCI Pass-through without an attached physical monitor, keyboard or mouse.</p><p>On your VM, install Windows binary from <a href=https://looking-glass.io/artifact/B7/host>https://looking-glass.io/artifact/B7/host</a></p><p>On your host, install the application client</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir host/build
</span></span><span style=display:flex><span>cd host/build
</span></span><span style=display:flex><span>cmake ..
</span></span><span style=display:flex><span>make
</span></span><span style=display:flex><span>make install
</span></span></code></pre></div><h3 id=tune-the-vm><a class=anchor href=#tune-the-vm>Tune the VM</a></h3><p>To optimize performance, edit the XML:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;cpu</span> <span style=color:#a6e22e>mode=</span><span style=color:#e6db74>&#39;host-passthrough&#39;</span> <span style=color:#a6e22e>check=</span><span style=color:#e6db74>&#39;none&#39;</span> <span style=color:#a6e22e>migratable=</span><span style=color:#e6db74>&#39;on&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;topology</span> <span style=color:#a6e22e>sockets=</span><span style=color:#e6db74>&#39;1&#39;</span> <span style=color:#a6e22e>dies=</span><span style=color:#e6db74>&#39;1&#39;</span> <span style=color:#a6e22e>clusters=</span><span style=color:#e6db74>&#39;1&#39;</span> <span style=color:#a6e22e>cores=</span><span style=color:#e6db74>&#39;4&#39;</span> <span style=color:#a6e22e>threads=</span><span style=color:#e6db74>&#39;2&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;maxphysaddr</span> <span style=color:#a6e22e>mode=</span><span style=color:#e6db74>&#39;passthrough&#39;</span> <span style=color:#a6e22e>limit=</span><span style=color:#e6db74>&#39;40&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;feature</span> <span style=color:#a6e22e>policy=</span><span style=color:#e6db74>&#39;disable&#39;</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#39;hypervisor&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/cpu&gt;</span>
</span></span></code></pre></div><p>Modifying the XML domain namespace to support <a href=qemu:commandline>qemu:commandline</a> block</p><domain type=kvm xmlns:qemu=http://libvirt.org/schemas/domain/qemu/1.0><p>Add the following <a href=qemu:commandline>qemu:commandline</a> block under <code>devices</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>  <span style=color:#f92672>&lt;qemu:commandline&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;qemu:arg</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#39;-device&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;qemu:arg</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#39;ivshmem-plain,id=shmem0,memdev=looking-glass,bus=pcie.0,addr=0x11&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;qemu:arg</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#39;-object&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;qemu:arg</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#39;memory-backend-file,id=looking-glass,mem-path=/dev/kvmfr0,size=128M,share=yes&#39;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/qemu:commandline&gt;</span>
</span></span></code></pre></div><p>Then restart your VM.</p><h3 id=final-test><a class=anchor href=#final-test>Final test</a></h3><p>Connect your HDMI Dummy Plug
On your host, connect to your VM with <code>./looking-glass-client -F</code></p></article></div></div></div></div></div></main><div class=container-xl><div class="pt-6 text-secondary border-top"><span>propulsed by
<a class="link-primary link-underline link-underline-opacity-0 link-underline-opacity-100-hover link-offset-2-hover" href=https://gohugo.io/>hugo</a>
and
<a class="link-primary link-underline link-underline-opacity-0 link-underline-opacity-100-hover link-offset-2-hover" href=https://github.com/dmachard/hugo-theme-gists>hugo-theme-gists</a></span></div></div></body><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js integrity=sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL crossorigin=anonymous></script>
<script type=application/javascript src=https://dmachard.github.io/js/gists.js></script></html>