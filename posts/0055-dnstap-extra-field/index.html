<!doctype html><html lang=en-US><head><meta charset=utf-8><meta name=viewport content="width=device-width"><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9 crossorigin=anonymous><link rel=stylesheet href=https://dmachard.github.io/css/gists.css><title>Play with extra DNStap field - My technical gists</title><link rel=icon type=image/x-icon href=/images/avatar.png><meta name=theme-color content="#1e2327"><meta name=description content="In this blog post, we will explore how to include additional metadata in your DNsStap logs, such as security flags, resolver IP addresses, and more."><meta name=keywords content="blog,technical"><meta name=robots content="noodp"><link rel=canonical href=https://dmachard.github.io/posts/0055-dnstap-extra-field/><meta name=twitter:card content="summary"><meta name=twitter:title content="Play with extra DNStap field  - My technical gists"><meta name=twitter:description content="In this blog post, we will explore how to include additional metadata in your DNsStap logs, such as security flags, resolver IP addresses, and more."><meta name=twitter:site content="https://dmachard.github.io/"><meta name=twitter:creator content><meta name=twitter:image content="https://dmachard.github.io/"><meta property="og:type" content="article"><meta property="og:title" content="Play with extra DNStap field  - My technical gists"><meta property="og:description" content="In this blog post, we will explore how to include additional metadata in your DNsStap logs, such as security flags, resolver IP addresses, and more."><meta property="og:url" content="https://dmachard.github.io/posts/0055-dnstap-extra-field/"><meta property="og:site_name" content="Play with extra DNStap field "><meta property="og:image" content="https://dmachard.github.io/"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2023-09-20 00:00:00 +0100 +0100"></head><body><main><div class=container-xl><div class="d-flex flex-sm-row flex-column"><div class="p-2 pt-0 col-sm-3"><div class="d-flex flex-column sticky-top"><div class="d-flex flex-sm-column"><div class="pt-3 pt-md-2 pb-2 order-sm-1 order-2"><p class="fs-4 fw-bold p-0 m-0">Denis Machard</p><p class="fs-5 text-dark-emphasis">My technical gists</p></div><div class="pt-2 pe-2 col-3 col-sm-12 order-sm-2 order-1"><a href=/images/profile.png><img width=250 class="img-thumbnail rounded-pill border bg-white" src=/images/profile.png></a></div></div><div class="mt-3 fs-6 text-dark-emphasis">Infrastructure architect by profession but always consider himself as a developer and an open source enthusiast.</div><div class=pt-3><ul class=list-unstyled><li><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M1.75 2A1.75 1.75.0 000 3.75v.736a.75.75.0 000 .027v7.737C0 13.216.784 14 1.75 14h12.5A1.75 1.75.0 0016 12.25v-8.5A1.75 1.75.0 0014.25 2H1.75zM14.5 4.07v-.32a.25.25.0 00-.25-.25H1.75a.25.25.0 00-.25.25v.32L8 7.88l6.5-3.81zm-13 1.74v6.441c0 .138.112.25.25.25h12.5a.25.25.0 00.25-.25V5.809L8.38 9.397a.75.75.0 01-.76.0L1.5 5.809z"/></svg><span class=m-1><a class="text-dark-emphasis link-underline link-underline-opacity-0 link-underline-opacity-100-hover link-offset-2-hover" href=mailto:d.machard@gmail.com>d.machard@gmail.com</a></span></li></ul></div><div class="pt-3 pb-4"><a style="margin:0 10px 10px 0" href=https://github.com/dmachard><img alt=@github width=32 height=32 src=https://dmachard.github.io/images/github.png></a>
<a style="margin:0 10px 10px 0" href=https://fosstodon.org/@dmachard><img alt=@mastodon width=32 height=32 src=https://dmachard.github.io/images/mastodon.png></a>
<a style="margin:0 10px 10px 0" href=https://dmachard.github.io/index.xml><img alt=@rss width=32 height=32 src=https://dmachard.github.io/images/rss.png></a></div></div></div><div class="p-2 pt-0 col-sm-9"><ul class="nav nav-underline sticky-top d-flex pt-2 mb-md-4 bg-white border-bottom"><li class="nav-item px-md-1"><a class="nav-link text-dark-emphasis" href=https://dmachard.github.io/><svg height="16" viewBox="0 0 16 16" width="16"><path class="me-1" fill-rule="evenodd" d="m11.294.984 3.722 3.722a1.75 1.75.0 01-.504 2.826l-1.327.613a3.089 3.089.0 00-1.707 2.084l-.584 2.454c-.317 1.332-1.972 1.8-2.94.832L5.75 11.311 1.78 15.28A.749.749.0 11.72 14.22l3.969-3.97-2.204-2.204c-.968-.968-.5-2.623.832-2.94l2.454-.584a3.08 3.08.0 002.084-1.707l.613-1.327a1.75 1.75.0 012.826-.504zM6.283 9.723l2.732 2.731a.25.25.0 00.42-.119l.584-2.454a4.586 4.586.0 012.537-3.098l1.328-.613a.25.25.0 00.072-.404l-3.722-3.722a.25.25.0 00-.404.072l-.613 1.328A4.584 4.584.0 016.119 5.981l-2.454.584a.25.25.0 00-.119.42l2.731 2.732z"/></svg><span class=m-1>Pinned</span>
<span class="badge fw-normal bg-secondary bg-opacity-25 text-opacity-50 rounded-pill text-dark-emphasis">4</span></a></li><li class="nav-item px-md-1"><a class='nav-link text-dark active' href=https://dmachard.github.io//posts/><svg height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M0 1.75A.75.75.0 01.75 1h4.253c1.227.0 2.317.59 3 1.501A3.744 3.744.0 0111.006 1h4.245a.75.75.0 01.75.75v10.5a.75.75.0 01-.75.75h-4.507a2.25 2.25.0 00-1.591.659l-.622.621a.75.75.0 01-1.06.0l-.622-.621A2.25 2.25.0 005.258 13H.75A.75.75.0 010 12.25V1.75zm8.755 3a2.25 2.25.0 012.25-2.25H14.5v9h-3.757c-.71.0-1.4.201-1.992.572l.004-7.322zm-1.504 7.324.004-5.073-.002-2.253A2.25 2.25.0 005.003 2.5H1.5v9h3.757a3.75 3.75.0 011.994.574z"/></svg><span class=m-1>Gists</span>
<span class="badge fw-normal bg-secondary bg-opacity-25 text-opacity-50 rounded-pill text-dark-emphasis">57</span></a></li><li class="nav-item px-md-1"><a class='nav-link text-dark-emphasis' href=https://dmachard.github.io//tags/><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M2.5 7.775V2.75a.25.25.0 01.25-.25h5.025a.25.25.0 01.177.073l6.25 6.25a.25.25.0 010 .354l-5.025 5.025a.25.25.0 01-.354.0l-6.25-6.25A.25.25.0 012.5 7.775zm-1.5.0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464.0.91.184 1.238.513l6.25 6.25a1.75 1.75.0 010 2.474l-5.026 5.026a1.75 1.75.0 01-2.474.0l-6.25-6.25A1.75 1.75.0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z"/></svg><span class=m-1>Tags</span>
<span class="badge fw-normal bg-secondary bg-opacity-25 text-opacity-50 rounded-pill text-dark-emphasis">37</span></a></li></ul><div class="d-flex flex-column border rounded mt-4 mt-md-0"><div class="border-bottom bg-light markdown-sticky-top"><div class="d-flex flex-row align-items-center"><div class=btn-group role=group><button type=button class=btn data-bs-toggle=dropdown aria-expanded=false><svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16"><path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zM3 8A1 1 0 111 8a1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"/></svg></button><ul class=dropdown-menu id=toc-list><li><h6 class=dropdown-header>Table of Content</h6></li></ul></div><div class="flex-fill text-secondary fs-7"><relative-time datetime="Wed, 20 Sep 2023 00:00:00 +0100"></relative-time></div><div class="pe-2 d-none d-md-block"><a class="badge text-bg-secondary text-dark fw-normal bg-opacity-25 pb-1 link-underline link-underline-opacity-0 link-underline-opacity-100-hover" href=/tags/dnstap>dnstap</a>
<a class="badge text-bg-secondary text-dark fw-normal bg-opacity-25 pb-1 link-underline link-underline-opacity-0 link-underline-opacity-100-hover" href=/tags/coredns>coredns</a>
<a class="badge text-bg-secondary text-dark fw-normal bg-opacity-25 pb-1 link-underline link-underline-opacity-0 link-underline-opacity-100-hover" href=/tags/dnsdist>dnsdist</a></div></div></div><div class="pt-4 px-2 pb-3"><article class="markdown-body container-lg"><h1 id=play-with-extra-dnstap-field>Play with Extra DNStap field</h1><p>In this blog post, we will explore how to include additional metadata in your <a href=https://dnstap.info/>DNStap</a> logs, such as security flags, resolver IP addresses, and more.
The DNStap protocol offers an <a href=https://github.com/dnstap/dnstap.pb/blob/master/dnstap.proto#L37>extra</a> field specifically designed for this purpose.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// Extra data for this payload.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// This field can be used for adding an arbitrary byte-string annotation to
</span></span></span><span style=display:flex><span><span style=color:#75715e>// the payload. No encoding or interpretation is applied or enforced.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>optional bytes      extra <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
</span></span></code></pre></div><p>Let&rsquo;s begin by exploring how to implement this feature in CoreDNS.</p><h2 id=coredns><a class=anchor href=#coredns>CoreDNS</a></h2><p>Support for the extra field was introduced in CoreDNS starting from <a href=https://github.com/coredns/coredns/releases/tag/v1.11.1>v1.11.1</a>.
Below is an example of how to add the upstream IP (either 8.8.8.8 or 9.9.9.9) to the extra field.</p><p>First, create the coredns.conf file. This configuration sets up your CoreDNS instance to:</p><ul><li>Listen on port 53 for DNS queries.</li><li>Enable metadata collection.</li><li>Send dnstapto the remote collector 10.0.0.100 on port 6000 with full logging.</li><li>Specify the identity as &ldquo;coredns&rdquo; for dnstap data.</li><li>Include upstream addresses in extra field</li><li>Cache DNS responses.</li><li>Forward DNS queries to both 8.8.8.8 and 9.9.9.9 as upstream resolvers.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>.:53 <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	metadata
</span></span><span style=display:flex><span>        dnstap tcp://10.0.0.100:6000 full <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		identity coredns
</span></span><span style=display:flex><span>		extra <span style=color:#f92672>{</span>/forward/upstream<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	cache
</span></span><span style=display:flex><span>        forward . 8.8.8.8 9.9.9.9
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Next, start CoreDNS using the Docker image:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo docker run -d -p 8053:53/tcp -p 8053:53/udp --name<span style=color:#f92672>=</span>coredns -v $PWD/coredns.conf:/config.conf coredns/coredns:1.11.1 -conf /config.conf
</span></span></code></pre></div><p>To retrieve DNS logs with support for the extra field, you can utilize the <a href=https://github.com/dmachard/go-dnscollector>DNS-collector</a></p><p>Create the dnscollector.conf file. This configuration sets up DNS collector (dnscollector) to listen on port tcp 6000 for incoming dnstap data and send it to the console logger in a specified text format that includes the timestamp, identity, operation, query IP, extra field, query name (qname), and response code (rcode).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>multiplexer</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>collectors</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tap</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>dnstap</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>listen-ip</span>: <span style=color:#ae81ff>0.0.0.0</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>listen-port</span>: <span style=color:#ae81ff>6000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>loggers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>console</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>stdout</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>mode</span>: <span style=color:#ae81ff>text</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>text-format</span>: <span style=color:#e6db74>&#34;timestamp-rfc3339ns identity operation queryip extra qname rcode&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>routes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>from</span>: [ <span style=color:#ae81ff>tap ]</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>to</span>: [ <span style=color:#ae81ff>console ]  </span>
</span></span></code></pre></div><p>Now, start the DNS-collector using the Docker image:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo docker run -d -p 6000:6000/tcp --name<span style=color:#f92672>=</span>dnscollector -v $PWD/dnscollector.conf:/config.conf dmachard/go-dnscollector:v0.36.0 -config /config.conf
</span></span></code></pre></div><p>Execute the dig command to perform a DNS resolution using your CoreDNS instance:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dig @127.0.0.1 -p <span style=color:#ae81ff>8053</span> www.twitter.com
</span></span></code></pre></div><p>To view the DNScollector logs and observe the extra field, use the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo docker logs dnscollector
</span></span></code></pre></div><p>You should see logs similar to the following, with the extra field equal to 8.8.8.8:53 and 9.9.9.9:53:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>023-09-20T18:08:17.912209255Z coredns1 FORWARDER_QUERY 172.17.0.1 8.8.8.8:53 www.google.com NOERROR
</span></span><span style=display:flex><span>2023-09-20T18:08:17.943256625Z coredns1 FORWARDER_RESPONSE 172.17.0.1 8.8.8.8:53 www.google.com NOERROR
</span></span><span style=display:flex><span>2023-09-20T18:08:17.943348497Z coredns1 CLIENT_RESPONSE 172.17.0.1 8.8.8.8:53 www.google.com NOERROR
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>2023-09-20T18:08:51.271234557Z coredns1 CLIENT_QUERY 172.17.0.1 - www.twitter.com NOERROR
</span></span><span style=display:flex><span>2023-09-20T18:08:51.271290121Z coredns1 FORWARDER_QUERY 172.17.0.1 9.9.9.9:53 www.twitter.com NOERROR
</span></span><span style=display:flex><span>2023-09-20T18:08:51.294051653Z coredns1 FORWARDER_RESPONSE 172.17.0.1 9.9.9.9:53 www.twitter.com NOERROR
</span></span><span style=display:flex><span>2023-09-20T18:08:51.294120571Z coredns1 CLIENT_RESPONSE 172.17.0.1 9.9.9.9:53 www.twitter.com NOERROR
</span></span></code></pre></div><h2 id=dnsdist><a class=anchor href=#dnsdist>DNSdist</a></h2><p>Next, continue into <a href=https://dnsdist.org>DNSdist</a>, a tool that offers greater flexibility in adding custom information to the extra field in dnstap messages.
Before getting started, within your working directory, generate certificates and a private key for use with the DNS over HTTPS (DoH) service:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>openssl rand -base64 <span style=color:#ae81ff>48</span> &gt; passphrase.txt
</span></span><span style=display:flex><span>openssl genrsa -aes128 -passout file:passphrase.txt -out server.key <span style=color:#ae81ff>2048</span>
</span></span><span style=display:flex><span>openssl req -new -passin file:passphrase.txt -key server.key -out server.csr -subj <span style=color:#e6db74>&#34;/C=FR/O=krkr/OU=Domain Control Validated/CN=*.test.dev&#34;</span>
</span></span><span style=display:flex><span>openssl rsa -in server.key -passin file:passphrase.txt -out doh.key
</span></span><span style=display:flex><span>openssl x509 -req -days <span style=color:#ae81ff>36500</span> -in server.csr -signkey doh.key -out doh.crt
</span></span></code></pre></div><p>Now, create the <code>config_dnsdist.conf</code> file with the following Lua configuration.
This DNSdist configuration listen on DoH service with backends load balancing (google, cloudflare, quad9)
The lua functions (alterDnstapQuery, alterDnstapResponse, alterDnstapCachedResponse) are used to customize the extra field in dnstap messages.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>addDOHLocal(<span style=color:#e6db74>&#34;0.0.0.0:443&#34;</span>, <span style=color:#e6db74>&#34;/etc/dnsdist/doh.crt&#34;</span>, <span style=color:#e6db74>&#34;/etc/dnsdist/doh.key&#34;</span>, <span style=color:#e6db74>&#34;/dns-query&#34;</span>, {keepIncomingHeaders<span style=color:#f92672>=</span><span style=color:#66d9ef>true</span>})
</span></span><span style=display:flex><span>setACL({<span style=color:#e6db74>&#39;0.0.0.0/0&#39;</span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>newServer({address <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1.1.1.1&#34;</span>, pool<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;poolA&#34;</span>})
</span></span><span style=display:flex><span>newServer({address <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;9.9.9.9&#34;</span>, pool<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;poolB&#34;</span>})
</span></span><span style=display:flex><span>newServer({address <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;8.8.8.8&#34;</span>, pool<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;poolB&#34;</span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>alterDnstapQuery</span>(dq, tap)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>local</span> ua <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> key,value <span style=color:#66d9ef>in</span> pairs(dq:getHTTPHeaders()) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> key <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;user-agent&#39;</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            ua <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  tap:setExtra(ua)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>alterDnstapResponse</span>(dr, tap)
</span></span><span style=display:flex><span>  tap:setExtra(dr.pool)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>alterDnstapCachedResponse</span>(dr, tap)
</span></span><span style=display:flex><span>  tap:setExtra(<span style=color:#e6db74>&#34;cached&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- init dnstap remote collector</span>
</span></span><span style=display:flex><span>rl <span style=color:#f92672>=</span> newFrameStreamTcpLogger(<span style=color:#e6db74>&#34;192.168.1.17:6000&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- rules for queries</span>
</span></span><span style=display:flex><span>addAction(AllRule(), DnstapLogAction(<span style=color:#e6db74>&#34;dnsdist1&#34;</span>, rl, alterDnstapQuery))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>addAction(ProbaRule(<span style=color:#ae81ff>0.5</span>), PoolAction(<span style=color:#e6db74>&#34;poolA&#34;</span>))
</span></span><span style=display:flex><span>addAction(AllRule(), PoolAction(<span style=color:#e6db74>&#34;poolB&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- rules for replies</span>
</span></span><span style=display:flex><span>addResponseAction(AllRule(), DnstapLogResponseAction(<span style=color:#e6db74>&#34;dnsdist1&#34;</span>, rl, alterDnstapResponse))
</span></span></code></pre></div><p>To start DNSdist using a Docker image, use the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo docker run -d -p 8443:443/tcp -p 8083:8080 --name<span style=color:#f92672>=</span>dnsdist -v $PWD/:/etc/dnsdist/:ro powerdns/dnsdist-18:1.8.1
</span></span></code></pre></div><p>To test the DNSdist configuration, you can install and use the <a href=https://github.com/natesales/q>q</a> client.
Then, perform a DoH resolution using your DNSdist server with the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./q www.google.fr A  @https://127.0.0.1:8443 --tls-no-verify
</span></span></code></pre></div><p>To view the DNScollector logs and observe the extra field, use the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo docker logs dnscollector
</span></span></code></pre></div><p>You should see logs similar to the following, which include the &ldquo;User-Agent&rdquo; of the HTTP client or the &ldquo;pool&rdquo; used:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>2023-09-20T20:20:39.423635597Z dnsdist1 CLIENT_RESPONSE 172.17.0.1 poolA www.google.fr NOERROR
</span></span><span style=display:flex><span>2023-09-20T20:20:42.883887269Z dnsdist1 CLIENT_QUERY 172.17.0.1 Go-http-client/1.1 www.google.fr NOERROR
</span></span><span style=display:flex><span>2023-09-20T20:20:42.899695506Z dnsdist1 CLIENT_RESPONSE 172.17.0.1 poolA www.google.fr NOERROR
</span></span><span style=display:flex><span>2023-09-20T20:20:43.241895751Z dnsdist1 CLIENT_QUERY 172.17.0.1 Go-http-client/1.1 www.google.fr NOERROR
</span></span><span style=display:flex><span>2023-09-20T20:20:43.254621667Z dnsdist1 CLIENT_RESPONSE 172.17.0.1 poolA www.google.fr NOERROR
</span></span><span style=display:flex><span>2023-09-20T20:20:43.611780251Z dnsdist1 CLIENT_QUERY 172.17.0.1 Go-http-client/1.1 www.google.fr NOERROR
</span></span><span style=display:flex><span>2023-09-20T20:20:43.628321105Z dnsdist1 CLIENT_RESPONSE 172.17.0.1 poolB www.google.fr NOERROR
</span></span></code></pre></div></article></div></div></div></div></div></main><div class=container-xl><div class="pt-6 text-secondary border-top"><span>propulsed by
<a class="link-primary link-underline link-underline-opacity-0 link-underline-opacity-100-hover link-offset-2-hover" href=https://gohugo.io/>hugo</a>
and
<a class="link-primary link-underline link-underline-opacity-0 link-underline-opacity-100-hover link-offset-2-hover" href=https://github.com/dmachard/hugo-theme-gists>hugo-theme-gists</a></span></div></div></body><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js integrity=sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL crossorigin=anonymous></script>
<script type=application/javascript src=https://dmachard.github.io/js/gists.js></script></html>