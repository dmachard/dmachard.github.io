<!doctype html><html lang=en-US><head><meta charset=utf-8><meta name=viewport content="width=device-width"><link rel=stylesheet href=https://dmachard.github.io/css/primer/core.min.css><link rel=stylesheet href=https://dmachard.github.io/css/primer/product.min.css><title>Ntpd: How to get statistics usage with ELK - My technical gists</title><link rel=icon type=image/x-icon href=/images/avatar.png><meta name=theme-color content="#1e2327"><meta name=description content="In this post, I will look at ntpd server to extract some ntp statitics.
Table of contents Activate ntpd logs peerstats documentation sysstats documentation Counting NTP clients Expected logs Export Logs to ELK Deploy Filebeat Configure Logstash Examples of dashboard on Kibana Activate ntpd logs Update the ntpd configuration
vim /etc/ntp.conf statsdir /var/log/ntpstats/ statistics peerstats sysstats filegen peerstats file peerstats.log type day enable filegen sysstats file sysstats.log type none enable Restart the daemon"><meta name=keywords content="blog,technical"><meta name=robots content="noodp"><link rel=canonical href=https://dmachard.github.io/posts/0002-ntpd-logs-elk/><meta name=twitter:card content="summary"><meta name=twitter:title content="Ntpd: How to get statistics usage with ELK - My technical gists"><meta name=twitter:description content="In this post, I will look at ntpd server to extract some ntp statitics.
Table of contents Activate ntpd logs peerstats documentation sysstats documentation Counting NTP clients Expected logs Export Logs to ELK Deploy Filebeat Configure Logstash Examples of dashboard on Kibana Activate ntpd logs Update the ntpd configuration
vim /etc/ntp.conf statsdir /var/log/ntpstats/ statistics peerstats sysstats filegen peerstats file peerstats.log type day enable filegen sysstats file sysstats.log type none enable Restart the daemon"><meta name=twitter:site content="https://dmachard.github.io/"><meta name=twitter:creator content><meta name=twitter:image content="https://dmachard.github.io/"><meta property="og:type" content="article"><meta property="og:title" content="Ntpd: How to get statistics usage with ELK - My technical gists"><meta property="og:description" content="In this post, I will look at ntpd server to extract some ntp statitics.
Table of contents Activate ntpd logs peerstats documentation sysstats documentation Counting NTP clients Expected logs Export Logs to ELK Deploy Filebeat Configure Logstash Examples of dashboard on Kibana Activate ntpd logs Update the ntpd configuration
vim /etc/ntp.conf statsdir /var/log/ntpstats/ statistics peerstats sysstats filegen peerstats file peerstats.log type day enable filegen sysstats file sysstats.log type none enable Restart the daemon"><meta property="og:url" content="https://dmachard.github.io/posts/0002-ntpd-logs-elk/"><meta property="og:site_name" content="Ntpd: How to get statistics usage with ELK"><meta property="og:image" content="https://dmachard.github.io/"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2020-06-20 00:00:00 +0100 +0100"></head><body><main><div class="mt-0 position-sticky top-0 d-none d-md-block bg-white width-full color-border-secondary" style=z-index:3><div class="container-xl px-3 px-md-4 px-lg-5"><div class="gutter-condensed gutter-lg flex-column flex-md-row d-flex"><div class="flex-shrink-0 col-12 col-md-3 mb-4 mb-md-0"><div class="vcard-names-container float-left col-10 col-md-12 pt-1 pt-md-3 pb-1 pb-md-3 js-sticky js-user-profile-sticky-fields" data-original-top=0px style=position:sticky><h1 class="vcard-names pl-2 pl-md-0"><span class="p-name vcard-fullname d-block overflow-hidden">Denis Machard</span>
<span class="p-nickname vcard-username d-block">My technical gists</span></h1></div></div><div class="flex-shrink-0 col-12 col-md-9 mb-4 mb-md-0"><div class="UnderlineNav width-full border-bottom box-shadow-none hx_UnderlineNav-with-profile-color-modes-banner"><nav class=UnderlineNav-body><a class=UnderlineNav-item href=https://dmachard.github.io/><svg class="octicon octicon-pin UnderlineNav-octicon hide-sm" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="m11.294.984 3.722 3.722a1.75 1.75.0 01-.504 2.826l-1.327.613a3.089 3.089.0 00-1.707 2.084l-.584 2.454c-.317 1.332-1.972 1.8-2.94.832L5.75 11.311 1.78 15.28A.749.749.0 11.72 14.22l3.969-3.97-2.204-2.204c-.968-.968-.5-2.623.832-2.94l2.454-.584a3.08 3.08.0 002.084-1.707l.613-1.327a1.75 1.75.0 012.826-.504zM6.283 9.723l2.732 2.731a.25.25.0 00.42-.119l.584-2.454a4.586 4.586.0 012.537-3.098l1.328-.613a.25.25.0 00.072-.404l-3.722-3.722a.25.25.0 00-.404.072l-.613 1.328A4.584 4.584.0 016.119 5.981l-2.454.584a.25.25.0 00-.119.42l2.731 2.732z"/></svg>Pinned</a>
<a class="UnderlineNav-item selected" href=https://dmachard.github.io//posts/><svg class="octicon octicon-repo UnderlineNav-octicon hide-sm" height="16" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M0 1.75A.75.75.0 01.75 1h4.253c1.227.0 2.317.59 3 1.501A3.744 3.744.0 0111.006 1h4.245a.75.75.0 01.75.75v10.5a.75.75.0 01-.75.75h-4.507a2.25 2.25.0 00-1.591.659l-.622.621a.75.75.0 01-1.06.0l-.622-.621A2.25 2.25.0 005.258 13H.75A.75.75.0 010 12.25V1.75zm8.755 3a2.25 2.25.0 012.25-2.25H14.5v9h-3.757c-.71.0-1.4.201-1.992.572l.004-7.322zm-1.504 7.324.004-5.073-.002-2.253A2.25 2.25.0 005.003 2.5H1.5v9h3.757a3.75 3.75.0 011.994.574z"/></svg>Gists
<span class=Counter>53</span></a>
<a class=UnderlineNav-item href=https://dmachard.github.io//tags/><svg class="octicon octicon-tag" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M2.5 7.775V2.75a.25.25.0 01.25-.25h5.025a.25.25.0 01.177.073l6.25 6.25a.25.25.0 010 .354l-5.025 5.025a.25.25.0 01-.354.0l-6.25-6.25A.25.25.0 012.5 7.775zm-1.5.0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464.0.91.184 1.238.513l6.25 6.25a1.75 1.75.0 010 2.474l-5.026 5.026a1.75 1.75.0 01-2.474.0l-6.25-6.25A1.75 1.75.0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z"/></svg>Tags
<span class=Counter>71</span></a></nav></div></div></div></div></div><div class="container-xl px-3 px-md-4 px-lg-5"><div class="gutter-condensed gutter-lg flex-column flex-md-row d-flex"><div class="flex-shrink-0 col-12 col-md-3 mb-4 mb-md-0"><div class="h-card pt-4 pt-md-0"><div class="clearfix d-flex d-md-block flex-items-center mb-4 mb-md-0"><div class="position-relative d-inline-block col-2 col-md-12 mr-3 mr-md-0 flex-shrink-0" style=z-index:2><a href=/images/profile.png><img style=height:auto alt=Avatar width=260 height=260 id=headerImg class="avatar avatar-user width-full border bg-white" src=/images/profile.png></a></div><div class="vcard-names-container d-md-none float-left col-10 col-md-12 pt-1 pt-md-3 pb-1 pb-md-3 js-sticky js-user-profile-sticky-fields" data-original-top=0px style=position:sticky><h1 class="vcard-names pl-2 pl-md-0"><span class="p-name vcard-fullname d-block overflow-hidden">Denis Machard</span>
<span class="p-nickname vcard-username d-block">My technical gists</span></h1></div></div><div class="p-note user-profile-bio mt-3 js-user-profile-bio f4"><div>Infrastructure architect by profession but always consider himself as a developer and an open source enthusiast.</div></div><div class="d-flex flex-column mt-3"><div class="js-profile-editable-area d-flex flex-column d-md-block"><ul class=vcard-details><li class="vcard-detail pt-1 css-truncate css-truncate-target"><svg class="octicon octicon-mail" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M1.75 2A1.75 1.75.0 000 3.75v.736a.75.75.0 000 .027v7.737C0 13.216.784 14 1.75 14h12.5A1.75 1.75.0 0016 12.25v-8.5A1.75 1.75.0 0014.25 2H1.75zM14.5 4.07v-.32a.25.25.0 00-.25-.25H1.75a.25.25.0 00-.25.25v.32L8 7.88l6.5-3.81zm-13 1.74v6.441c0 .138.112.25.25.25h12.5a.25.25.0 00.25-.25V5.809L8.38 9.397a.75.75.0 01-.76.0L1.5 5.809z"/></svg><a class="u-email link-gray-dark" href=mailto:d.machard@gmail.com>d.machard@gmail.com</a></li></ul></div></div><div class="color-border-secondary pt-3 mt-3 clearfix hide-sm hide-md"><div style=display:flex;justify-content:flex-start;flex-wrap:wrap;margin-bottom:3px><a style="margin:0 10px 10px 0" href=https://github.com/dmachard><svg id="github-icon" viewBox="0 0 16 16" width="32" height="32" fill="#24292e"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a><a style="margin:0 10px 10px 0" href=https://fosstodon.org/@dmachard><img alt=@linkedin width=32 height=32 src=https://dmachard.github.io/images/mastodon.png class=avatar></a>
<a style="margin:0 10px 10px 0" href=https://dmachard.github.io/index.xml><img alt=@rss width=32 height=32 src=https://dmachard.github.io/images/rss.png class=avatar></a></div></div></div></div><div class="flex-shrink-0 col-12 col-md-9 mb-4 mb-md-0"><div class="UnderlineNav user-profile-nav d-block d-md-none position-sticky top-0 pl-3 ml-n3 mr-n3 pr-3 bg-white" style=z-index:3><nav class=UnderlineNav-body><a class=UnderlineNav-item href=https://dmachard.github.io/>Pinned</a>
<a class='UnderlineNav-item selected' href=https://dmachard.github.io//posts/>Gists
<span class=Counter>53</span></a>
<a class=UnderlineNav-item href=https://dmachard.github.io//tags/>Tags
<span class=Counter>53</span></a></nav></div><div class="file mt-md-0"><div id=post-header class="file-header d-flex flex-items-start" style=z-index:2><div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto"><div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0"><summary id=toc-toggle onclick=clickToc() class="btn btn-octicon m-0 mr-2 p-2"><svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered"><path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zM3 8A1 1 0 111 8a1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"/></svg></summary><details-menu class=SelectMenu id=toc-details style="display: none;"><div class="SelectMenu-modal rounded-3 mt-1" style=max-height:340px><div class="SelectMenu-list SelectMenu-list--borderless p-2" style=overscroll-behavior:contain id=toc-list></div></div></details-menu>Created <relative-time datetime="Sat, 20 Jun 2020 00:00:00 +0100" class=no-wrap>Sat, 20 Jun 2020 00:00:00 +0100</relative-time>
<span class=file-info-divider></span>
Modified <relative-time datetime="Sun, 03 Sep 2023 20:45:25 +0000" class=no-wrap>Sun, 03 Sep 2023 20:45:25 +0000</relative-time></div><div class="file-actions flex-order-2 pt-0 d-none d-md-block"><a class="muted-link mr-3" href=/tags/ntp><svg class="octicon octicon-tag" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M2.5 7.775V2.75a.25.25.0 01.25-.25h5.025a.25.25.0 01.177.073l6.25 6.25a.25.25.0 010 .354l-5.025 5.025a.25.25.0 01-.354.0l-6.25-6.25A.25.25.0 012.5 7.775zm-1.5.0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464.0.91.184 1.238.513l6.25 6.25a1.75 1.75.0 010 2.474l-5.026 5.026a1.75 1.75.0 01-2.474.0l-6.25-6.25A1.75 1.75.0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z"/></svg>ntp</a>
<a class="muted-link mr-3" href=/tags/logs><svg class="octicon octicon-tag" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M2.5 7.775V2.75a.25.25.0 01.25-.25h5.025a.25.25.0 01.177.073l6.25 6.25a.25.25.0 010 .354l-5.025 5.025a.25.25.0 01-.354.0l-6.25-6.25A.25.25.0 012.5 7.775zm-1.5.0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464.0.91.184 1.238.513l6.25 6.25a1.75 1.75.0 010 2.474l-5.026 5.026a1.75 1.75.0 01-2.474.0l-6.25-6.25A1.75 1.75.0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z"/></svg>logs</a></div></div></div><div class="Box-body px-5 pb-5" style=z-index:1><article class="markdown-body entry-content container-lg"><p>In this post, I will look at ntpd server to extract some ntp statitics.</p><h2 id=table-of-contents>Table of contents</h2><ul><li><a href=#activate-ntpd-logs>Activate ntpd logs</a><ul><li><a href=#peerstats-documentation>peerstats documentation</a></li><li><a href=#sysstats-documentation>sysstats documentation</a></li></ul></li><li><a href=#counting-ntp-clients>Counting NTP clients</a></li><li><a href=#expected-logs>Expected logs</a></li><li><a href=#export-logs-to-elk>Export Logs to ELK</a><ul><li><a href=#deploy-filebeat>Deploy Filebeat</a></li><li><a href=#configure-logstash>Configure Logstash</a></li></ul></li><li><a href=#examples-of-dashboard-on-kibana>Examples of dashboard on Kibana</a></li></ul><h2 id=activate-ntpd-logs>Activate ntpd logs</h2><p>Update the ntpd configuration</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vim /etc/ntp.conf
</span></span><span style=display:flex><span>statsdir /var/log/ntpstats/
</span></span><span style=display:flex><span>statistics peerstats sysstats
</span></span><span style=display:flex><span>filegen peerstats file peerstats.log type day enable
</span></span><span style=display:flex><span>filegen sysstats file sysstats.log type none enable
</span></span></code></pre></div><p>Restart the daemon</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart ntpd
</span></span></code></pre></div><h3 id=peerstats-documentation>peerstats documentation</h3><p>Record peer statistics.
An event occurs upon an update from either another NTP server</p><table><thead><tr><th>Units</th><th>Description</th></tr></thead><tbody><tr><td>MJD</td><td>date</td></tr><tr><td>s</td><td>time past midnight</td></tr><tr><td>IP</td><td>source address</td></tr><tr><td>hex</td><td>status word</td></tr><tr><td>s</td><td>clock offset</td></tr><tr><td>s</td><td>roundtrip delay</td></tr><tr><td>s</td><td>dispersion</td></tr><tr><td>s</td><td>jitter</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tailf /var/log/ntpstats/peerstats
</span></span><span style=display:flex><span><span style=color:#ae81ff>58927</span> 1293.735 91.224.149.41 941a -0.031646296 0.047783430 0.019218732 0.002787419
</span></span><span style=display:flex><span><span style=color:#ae81ff>58927</span> 1315.710 129.250.35.250 945a -0.033762728 0.027946319 0.019098537 0.001580388
</span></span><span style=display:flex><span><span style=color:#ae81ff>58927</span> 1848.736 193.141.27.6 941a -0.034690903 0.054624853 0.015236537 0.001218647
</span></span><span style=display:flex><span><span style=color:#ae81ff>58927</span> 2006.714 92.222.117.115 961a -0.033217220 0.031581741 0.015059831 0.001349028
</span></span></code></pre></div><table><thead><tr><th></th><th>Definition</th></tr></thead><tbody><tr><td>delay</td><td>Shows the round trip time (RTT) of your computer communicating with the remote server.</td></tr><tr><td>offset</td><td>Using root mean squares, and shows how far off your clock is from the reported time the server gave you. It can be positive or negative.</td></tr><tr><td>jitter</td><td>Showing the root mean squared deviation of your offsets.</td></tr></tbody></table><h3 id=sysstats-documentation>sysstats documentation</h3><p>Each hour one line is appended to the sysstats file set in the following format</p><table><thead><tr><th>Units</th><th>Description</th></tr></thead><tbody><tr><td>MJD</td><td>date</td></tr><tr><td>s</td><td>time past midnight</td></tr><tr><td>s</td><td>time since reset</td></tr><tr><td></td><td>packets received</td></tr><tr><td></td><td>packets generated</td></tr><tr><td></td><td>current versions</td></tr><tr><td></td><td>old version</td></tr><tr><td></td><td>access denied</td></tr><tr><td></td><td>bad length or format</td></tr><tr><td></td><td>bad authentication</td></tr><tr><td></td><td>declined</td></tr><tr><td></td><td>rate exceeded</td></tr><tr><td></td><td>kiss-o&rsquo;-death packets sent</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tailf /var/log/ntpstats/sysstats
</span></span><span style=display:flex><span><span style=color:#ae81ff>58927</span> 52035.251 <span style=color:#ae81ff>3599</span> <span style=color:#ae81ff>225</span> <span style=color:#ae81ff>205</span> <span style=color:#ae81ff>225</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>58927</span> 55635.257 <span style=color:#ae81ff>3600</span> <span style=color:#ae81ff>88</span> <span style=color:#ae81ff>88</span> <span style=color:#ae81ff>88</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>58927</span> 59235.313 <span style=color:#ae81ff>3600</span> <span style=color:#ae81ff>49</span> <span style=color:#ae81ff>49</span> <span style=color:#ae81ff>49</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h2 id=counting-ntp-clients>Counting NTP clients</h2><p>The ntpd does not give you how many clients it serves.</p><p>Install iptables</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum remove firewalld <span style=color:#f92672>&amp;&amp;</span> yum install iptables-services
</span></span><span style=display:flex><span>systemctl enable iptables.service
</span></span></code></pre></div><p>Add the rule to log UDP port 123 traffic</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/sbin/iptables -A INPUT -p udp --dport <span style=color:#ae81ff>123</span> -j LOG --log-prefix<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;[NTP] &#39;</span> --log-level debug
</span></span><span style=display:flex><span>/usr/libexec/iptables/iptables.init save
</span></span></code></pre></div><p>Update rsyslog to log NTP traffic in specific file</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>touch /etc/rsyslog.d/00-iptables.conf
</span></span><span style=display:flex><span>vim /etc/rsyslog.d/00-iptables.conf
</span></span><span style=display:flex><span>:msg,contains,<span style=color:#e6db74>&#34;[NTP] &#34;</span> /var/log/ntpstats/iptables.log
</span></span></code></pre></div><p>Restart rsyslog</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>service rsyslog restart
</span></span></code></pre></div><p>Example of log</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># tailf /var/log/ntpstats/iptables.log</span>
</span></span><span style=display:flex><span>Mar <span style=color:#ae81ff>19</span> 06:56:10 localhost kernel: <span style=color:#f92672>[</span>NTP<span style=color:#f92672>]</span> IN<span style=color:#f92672>=</span>enp0s3 OUT<span style=color:#f92672>=</span> MAC<span style=color:#f92672>=</span>08:00:27:96:57:49:a0:40:a0:8d:29:95:08:00 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>SRC<span style=color:#f92672>=</span>185.242.56.3 DST<span style=color:#f92672>=</span>10.0.0.33 LEN<span style=color:#f92672>=</span><span style=color:#ae81ff>76</span> TOS<span style=color:#f92672>=</span>0x00 PREC<span style=color:#f92672>=</span>0x00 TTL<span style=color:#f92672>=</span><span style=color:#ae81ff>44</span> ID<span style=color:#f92672>=</span><span style=color:#ae81ff>56768</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>DF PROTO<span style=color:#f92672>=</span>UDP SPT<span style=color:#f92672>=</span><span style=color:#ae81ff>123</span> DPT<span style=color:#f92672>=</span><span style=color:#ae81ff>123</span> LEN<span style=color:#f92672>=</span><span style=color:#ae81ff>56</span>
</span></span></code></pre></div><h2 id=expected-logs>Expected logs</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ntpstats<span style=color:#f92672>]</span><span style=color:#75715e># ll</span>
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>740</span>
</span></span><span style=display:flex><span>-rw-------. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>669741</span> Mar <span style=color:#ae81ff>22</span> 08:42 iptables.log
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>2</span> ntp  ntp    <span style=color:#ae81ff>3549</span> Mar <span style=color:#ae81ff>22</span> 07:14 peerstats.log
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> ntp  ntp   <span style=color:#ae81ff>32829</span> Mar <span style=color:#ae81ff>21</span> 00:58 peerstats.log.20200320
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> ntp  ntp   <span style=color:#ae81ff>16910</span> Mar <span style=color:#ae81ff>22</span> 00:59 peerstats.log.20200321
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>2</span> ntp  ntp    <span style=color:#ae81ff>3549</span> Mar <span style=color:#ae81ff>22</span> 07:14 peerstats.log.20200322
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>2</span> ntp  ntp     <span style=color:#ae81ff>347</span> Mar <span style=color:#ae81ff>22</span> 08:35 sysstats.log
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> ntp  ntp     <span style=color:#ae81ff>980</span> Mar <span style=color:#ae81ff>21</span> 00:46 sysstats.log.20200320
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> ntp  ntp    <span style=color:#ae81ff>1041</span> Mar <span style=color:#ae81ff>22</span> 00:35 sysstats.log.20200321
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>2</span> ntp  ntp     <span style=color:#ae81ff>347</span> Mar <span style=color:#ae81ff>22</span> 08:35 sysstats.log.20200322
</span></span></code></pre></div><h2 id=export-logs-to-elk>Export Logs to ELK</h2><h3 id=deploy-filebeat>Deploy Filebeat</h3><p>Install filebeat, follow this procedure</p><p>Configure filebeat</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vim /etc/filebeat/filebeat.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>filebeat.inputs:
</span></span><span style=display:flex><span>- type: log
</span></span><span style=display:flex><span>	enabled: true
</span></span><span style=display:flex><span>	paths:
</span></span><span style=display:flex><span>	- /var/log/ntpstats/iptables.log
</span></span><span style=display:flex><span>	fields:
</span></span><span style=display:flex><span>	logtype: iptables
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- type: log
</span></span><span style=display:flex><span>	enabled: true
</span></span><span style=display:flex><span>	paths:
</span></span><span style=display:flex><span>	- /var/log/ntpstats/peerstats.log
</span></span><span style=display:flex><span>	fields:
</span></span><span style=display:flex><span>	logtype: peerstats
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- type: log
</span></span><span style=display:flex><span>	enabled: true
</span></span><span style=display:flex><span>	paths:
</span></span><span style=display:flex><span>	- /var/log/ntpstats/sysstats.log
</span></span><span style=display:flex><span>	fields:
</span></span><span style=display:flex><span>	logtype: sysstats
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>output.logstash:
</span></span><span style=display:flex><span>	hosts: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;&lt;ip_logstash&gt;:5044&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Start filebeat</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start filebeat
</span></span></code></pre></div><h3 id=configure-logstash>Configure Logstash</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>touch /etc/logstash/conf.d/00-beats.conf
</span></span><span style=display:flex><span>vim /etc/logstash/conf.d/00-beats.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>input <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	beats <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	port <span style=color:#f92672>=</span>&gt; <span style=color:#ae81ff>5044</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>filter <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span><span style=color:#f92672>(</span> <span style=color:#f92672>[</span>fields<span style=color:#f92672>][</span>logtype<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;iptables&#34;</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>	dissect <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		mapping <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;message&#34;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#34;%{} %{} %{} %{} kernel: [NTP] IN=%{} OUT=%{} MAC=%{} SRC=%{ntp_clientip} %{}&#34;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span><span style=color:#f92672>([</span>ntp_clientip<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&lt;ip1_ntp_peer&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	drop <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span><span style=color:#f92672>(</span> <span style=color:#f92672>[</span>fields<span style=color:#f92672>][</span>logtype<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;peerstats&#34;</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>	dissect <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		mapping <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;message&#34;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#34;%{datemjd} %{timepast_midnight} %{src_addr} %{status_word} %{clock_offset} %{roundtrip_delay} %{dispersion} %{rms_jitter}&#34;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	mutate <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	convert <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;clock_offset&#34;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#34;float&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;roundtrip_delay&#34;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#34;float&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;dispersion&#34;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#34;float&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;rms_jitter&#34;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#34;float&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span><span style=color:#f92672>(</span> <span style=color:#f92672>[</span>fields<span style=color:#f92672>][</span>logtype<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;sysstats&#34;</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>	dissect <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		mapping <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;message&#34;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#34;%{date_mjd} %{timepast_midnight} %{timesince_reset} %{pkts_received} %{pkts_generated} %{pkts_ntpv4} %{pkts_ntpv3} %{pkts_denied} %{pkts_bad} %{bad_auth} %{declined} %{rate_exceeded} %{pkts_kiss}&#34;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		mutate <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	convert <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;pkts_received&#34;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#34;integer&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;pkts_generated&#34;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#34;integer&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;pkts_ntpv4&#34;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#34;integer&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;pkts_ntpv3&#34;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#34;integer&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;pkts_denied&#34;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#34;integer&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;pkts_bad&#34;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#34;integer&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;bad_auth&#34;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#34;integer&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;declined&#34;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#34;integer&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;rate_exceeded&#34;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#34;integer&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;pkts_kiss&#34;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#34;integer&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>output <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	elasticsearch <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	hosts <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;http://localhost:9200&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>	index <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#34;%{[@metadata][beat]}-%{[@metadata][version]}&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=examples-of-dashboard-on-kibana>Examples of dashboard on Kibana</h2><p><img src=/images/0002/ntp-elk-dashboard.png alt="ELK dashboard image"></p><p><img src=/images/0002/ntp-elk-dashboard-offset.png alt="ELK dashboard image"></p></article></div></div><script type=application/javascript src=https://dmachard.github.io/js/toc.js></script>
<link rel=stylesheet href=https://dmachard.github.io/css/toc.css></div></div></div></main><div class="footer container-xl width-full p-responsive"><div class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light"><span>Propulsed by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/dmachard/hugo-theme-gists>hugo-theme-gists</a></li></span></div></div></body><script type=application/javascript src=https://dmachard.github.io/js/lib.js></script></html>